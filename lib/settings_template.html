<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Hammerspoon 설정</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        margin: 0;
        padding: 20px;
        color: white;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 30px;
        backdrop-filter: blur(10px);
      }
      h1 {
        text-align: center;
        margin-bottom: 30px;
      }
      .section {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input,
      select {
        width: 100%;
        padding: 10px;
        border: none;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.9);
        color: #333;
        box-sizing: border-box;
      }
      button {
        padding: 15px 30px;
        border: none;
        border-radius: 25px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        margin: 5px;
      }
      .btn-save {
        background: #4caf50;
        color: white;
      }
      .btn-cancel {
        background: #f44336;
        color: white;
      }
      .button-group {
        text-align: center;
        margin-top: 30px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>⚙️ Hammerspoon 설정</h1>

      <div class="section">
        <h2>📁 Cursor 설정</h2>
        <div class="form-group">
          <label for="defaultFolder">기본 폴더 경로:</label>
          <input
            type="text"
            id="defaultFolder"
            placeholder="예: /Users/username/Desktop/back"
            value="{{DEFAULT_FOLDER}}"
          />
        </div>
      </div>

      <div class="section">
        <h2>🎨 Chooser UI 설정</h2>
        <div class="form-group">
          <label for="chooserWidth">화면 너비 (%):</label>
          <input
            type="number"
            id="chooserWidth"
            min="10"
            max="90"
            value="{{CHOOSER_WIDTH}}"
          />
        </div>
        <div class="form-group">
          <label for="chooserRows">최대 표시 줄 수:</label>
          <input
            type="number"
            id="chooserRows"
            min="3"
            max="20"
            value="{{CHOOSER_ROWS}}"
          />
        </div>
        <div class="form-group">
          <label for="bgDark">다크 모드:</label>
          <select id="bgDark">
            <option value="true" {{BG_DARK_TRUE}}>켜기</option>
            <option value="false" {{BG_DARK_FALSE}}>끄기</option>
          </select>
        </div>
      </div>

      <div class="button-group">
        <button class="btn-save" onclick="saveSettings()">💾 저장</button>
        <button class="btn-cancel" onclick="closeModal()">❌ 닫기</button>
      </div>
    </div>

    <script>
      // Hammerspoon 객체를 직접 정의 (injectScript 대신)
      window.hammerspoon = {
        saveSettings: function (data) {
          // URL 변경으로 데이터 전달
          window.location.href = "hammerspoon://save?" + JSON.stringify(data);
        },
      };

      // 설정 저장
      function saveSettings() {
        try {

          // 입력값 가져오기
          const defaultFolder = document.getElementById("defaultFolder").value;
          const chooserWidthElement = document.getElementById("chooserWidth");
          const chooserRowsElement = document.getElementById("chooserRows");
          const bgDarkElement = document.getElementById("bgDark");

          // 요소 존재 확인
          if (!chooserWidthElement || !chooserRowsElement || !bgDarkElement) {
            throw new Error("필수 입력 요소를 찾을 수 없습니다");
          }

          const chooserWidth = parseInt(chooserWidthElement.value);
          const chooserRows = parseInt(chooserRowsElement.value);
          const bgDark = bgDarkElement.value === "true";


          // 입력값 검증
          if (isNaN(chooserWidth) || chooserWidth < 10 || chooserWidth > 90) {
            throw new Error("Chooser 너비는 10-90 사이의 숫자여야 합니다");
          }

          if (isNaN(chooserRows) || chooserRows < 3 || chooserRows > 20) {
            throw new Error("Chooser 행 수는 3-20 사이의 숫자여야 합니다");
          }

          if (!defaultFolder || defaultFolder.trim() === "") {
            throw new Error("기본 폴더 경로를 입력해주세요");
          }

          // 데이터 객체 생성
          const settingsData = {
            defaultFolder: defaultFolder.trim(),
            chooserWidth: chooserWidth,
            chooserRows: chooserRows,
            bgDark: bgDark,
          };


          // Hammerspoon 연결 확인
          if (typeof window.hammerspoon === "undefined") {
            throw new Error("Hammerspoon 객체가 정의되지 않았습니다");
          }

          if (typeof window.hammerspoon.saveSettings !== "function") {
            throw new Error("saveSettings 함수를 찾을 수 없습니다");
          }


          // Hammerspoon에 데이터 전달
          window.hammerspoon.saveSettings(settingsData);
        } catch (error) {
          alert("저장 중 오류가 발생했습니다:\n\n" + error.message);
        }
      }

      // 모달 닫기
      function closeModal() {
        try {
          window.close();
        } catch (error) {
          alert("모달을 닫을 수 없습니다. Hammerspoon을 통해 닫아주세요.");
        }
      }

      // Hammerspoon 주입 완료 콜백
      window.hammerspoonReady = function () {
        updateConnectionStatus(true);
      };

      // 연결 상태 업데이트
      function updateConnectionStatus(connected) {
        const statusElement = document.getElementById("connectionStatus");
        if (statusElement) {
          if (connected) {
            statusElement.textContent = "✅ Hammerspoon 연결됨";
            statusElement.style.color = "#4caf50";
          } else {
            statusElement.textContent = "❌ Hammerspoon 연결 대기 중...";
            statusElement.style.color = "#ff9800";
          }
        }
      }

      // 페이지 로드 완료 후 초기화
      document.addEventListener("DOMContentLoaded", function () {

        // 연결 상태 표시 요소 생성
        const statusDiv = document.createElement("div");
        statusDiv.id = "connectionStatus";
        statusDiv.style.cssText =
          "text-align: center; margin: 10px 0; font-weight: bold;";
        statusDiv.textContent = "❌ Hammerspoon 연결 대기 중...";
        statusDiv.style.color = "#ff9800";

        // 버튼 그룹 앞에 상태 표시 삽입
        const buttonGroup = document.querySelector(".button-group");
        if (buttonGroup && buttonGroup.parentNode) {
          buttonGroup.parentNode.insertBefore(statusDiv, buttonGroup);
        }

        // Hammerspoon 객체 확인 (이제 직접 정의되므로 항상 존재해야 함)
        if (
          typeof window.hammerspoon !== "undefined" &&
          typeof window.hammerspoon.saveSettings === "function"
        ) {
          // Hammerspoon 객체 확인됨
          updateConnectionStatus(true);
        } else {
          // Hammerspoon 객체가 예상과 다름
          updateConnectionStatus(false);

          // 저장 버튼 비활성화
          const saveButton = document.querySelector(".btn-save");
          if (saveButton) {
            saveButton.disabled = true;
            saveButton.textContent = "❌ 연결 실패";
            saveButton.style.opacity = "0.5";
          }
        }
      });
    </script>
  </body>
</html>
